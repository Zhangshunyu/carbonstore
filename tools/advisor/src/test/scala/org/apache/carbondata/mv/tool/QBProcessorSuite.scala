/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.carbondata.mv.tool

import scala.collection.mutable

import org.apache.spark.sql.SparkSession
import org.scalatest.BeforeAndAfter

import org.apache.carbondata.mv.testutil.Tpcds_1_4_Tables._
import org.apache.carbondata.mv.plans.modular.ModularPlan
import org.apache.carbondata.mv.testutil.{ModularPlanTest, Tpcds_1_4_QueryBatch}

class QBProcessorSuite extends ModularPlanTest with BeforeAndAfter {

  val spark = SparkSession.builder().master("local").enableHiveSupport().getOrCreate()
  val testHive = new org.apache.spark.sql.hive.test.TestHiveContext(spark.sparkContext, false)
  val hiveClient = testHive.sparkSession.metadataHive
  
  class MVToolTest extends MVToolBase {
    override protected def getMVFilePath: String = ""
  }
  
  val correctPlanBatch = Seq[String](
      s"""
         |Select [c_customer_id#83], [ctr_customer_sk#1, ctr_store_sk#2, ctr_total_return#3, (CAST(avg(ctr_total_return) AS DECIMAL(21,6)) * CAST(1.2 AS DECIMAL(21,6)))#101, ctr_store_sk#2#104, s_store_sk#53, s_store_id#54, s_rec_start_date#55, s_rec_end_date#56, s_closed_date_sk#57, s_store_name#58, s_number_employees#59, s_floor_space#60, s_hours#61, s_manager#62, s_market_id#63, s_geography_class#64, s_market_desc#65, s_market_manager#66, s_division_id#67, s_division_name#68, s_company_id#69, s_company_name#70, s_street_number#71, ... 28 more fields], [(cast(ctr_total_return#3 as decimal(24,7)) > (CAST(avg(ctr_total_return) AS DECIMAL(21,6)) * CAST(1.2 AS DECIMAL(21,6)))#101), (ctr_store_sk#2 = ctr_store_sk#2#104), (s_state#77 = TN), (s_store_sk#53 = ctr_store_sk#2), (ctr_customer_sk#1 = c_customer_sk#82)], Map(2 -> store, 3 -> customer), [JoinEdge(0,1,Inner), JoinEdge(0,2,Inner), JoinEdge(0,3,Inner)], 14, [List(100), List(ArrayBuffer(c_customer_id#83 ASC NULLS FIRST))]
         |:- GroupBy [sr_customer_sk#7 AS ctr_customer_sk#1, sr_store_sk#11 AS ctr_store_sk#2, sum(sr_return_amt#15) AS ctr_total_return#3], [sr_customer_sk#7, sr_store_sk#11, sr_return_amt#15], [sr_customer_sk#7, sr_store_sk#11], 0
         |:  +- Select [sr_customer_sk#7, sr_store_sk#11, sr_return_amt#15], [sr_returned_date_sk#4, sr_return_time_sk#5, sr_item_sk#6, sr_customer_sk#7, sr_cdemo_sk#8, sr_hdemo_sk#9, sr_addr_sk#10, sr_store_sk#11, sr_reason_sk#12, sr_ticket_number#13L, sr_return_quantity#14, sr_return_amt#15, sr_return_tax#16, sr_return_amt_inc_tax#17, sr_fee#18, sr_return_ship_cost#19, sr_refunded_cash#20, sr_reversed_charge#21, sr_store_credit#22, sr_net_loss#23, d_date_sk#24, d_date_id#25, d_date#26, d_month_seq#27, ... 24 more fields], [(d_year#30 = 2000), (sr_returned_date_sk#4 = d_date_sk#24)], Map(0 -> store_returns, 1 -> date_dim), [JoinEdge(0,1,Inner)], 0
         |:     :- ModularTable default, store_returns, [sr_returned_date_sk#4, sr_return_time_sk#5, sr_item_sk#6, sr_customer_sk#7, sr_cdemo_sk#8, sr_hdemo_sk#9, sr_addr_sk#10, sr_store_sk#11, sr_reason_sk#12, sr_ticket_number#13L, sr_return_quantity#14, sr_return_amt#15, sr_return_tax#16, sr_return_amt_inc_tax#17, sr_fee#18, sr_return_ship_cost#19, sr_refunded_cash#20, sr_reversed_charge#21, sr_store_credit#22, sr_net_loss#23], 0
         |:     +- ModularTable default, date_dim, [d_date_sk#24, d_date_id#25, d_date#26, d_month_seq#27, d_week_seq#28, d_quarter_seq#29, d_year#30, d_dow#31, d_moy#32, d_dom#33, d_qoy#34, d_fy_year#35, d_fy_quarter_seq#36, d_fy_week_seq#37, d_day_name#38, d_quarter_name#39, d_holiday#40, d_weekend#41, d_following_holiday#42, d_first_dom#43, d_last_dom#44, d_same_day_ly#45, d_same_day_lq#46, d_current_day#47, ... 4 more fields], 0
         |:- GroupBy [CheckOverflow((avg(ctr_total_return#3) * 1.200000), DecimalType(24,7)) AS (CAST(avg(ctr_total_return) AS DECIMAL(21,6)) * CAST(1.2 AS DECIMAL(21,6)))#101, ctr_store_sk#2 AS ctr_store_sk#2#104], [ctr_store_sk#2, ctr_total_return#3], [ctr_store_sk#2], 0
         |:  +- GroupBy [sr_store_sk#11 AS ctr_store_sk#2, sum(sr_return_amt#15) AS ctr_total_return#3], [sr_customer_sk#7, sr_store_sk#11, sr_return_amt#15], [sr_customer_sk#7, sr_store_sk#11], 0
         |:     +- Select [sr_customer_sk#7, sr_store_sk#11, sr_return_amt#15], [sr_returned_date_sk#4, sr_return_time_sk#5, sr_item_sk#6, sr_customer_sk#7, sr_cdemo_sk#8, sr_hdemo_sk#9, sr_addr_sk#10, sr_store_sk#11, sr_reason_sk#12, sr_ticket_number#13L, sr_return_quantity#14, sr_return_amt#15, sr_return_tax#16, sr_return_amt_inc_tax#17, sr_fee#18, sr_return_ship_cost#19, sr_refunded_cash#20, sr_reversed_charge#21, sr_store_credit#22, sr_net_loss#23, d_date_sk#24, d_date_id#25, d_date#26, d_month_seq#27, ... 24 more fields], [(d_year#30 = 2000), (sr_returned_date_sk#4 = d_date_sk#24)], Map(0 -> store_returns, 1 -> date_dim), [JoinEdge(0,1,Inner)], 0
         |:        :- ModularTable default, store_returns, [sr_returned_date_sk#4, sr_return_time_sk#5, sr_item_sk#6, sr_customer_sk#7, sr_cdemo_sk#8, sr_hdemo_sk#9, sr_addr_sk#10, sr_store_sk#11, sr_reason_sk#12, sr_ticket_number#13L, sr_return_quantity#14, sr_return_amt#15, sr_return_tax#16, sr_return_amt_inc_tax#17, sr_fee#18, sr_return_ship_cost#19, sr_refunded_cash#20, sr_reversed_charge#21, sr_store_credit#22, sr_net_loss#23], 0
         |:        +- ModularTable default, date_dim, [d_date_sk#24, d_date_id#25, d_date#26, d_month_seq#27, d_week_seq#28, d_quarter_seq#29, d_year#30, d_dow#31, d_moy#32, d_dom#33, d_qoy#34, d_fy_year#35, d_fy_quarter_seq#36, d_fy_week_seq#37, d_day_name#38, d_quarter_name#39, d_holiday#40, d_weekend#41, d_following_holiday#42, d_first_dom#43, d_last_dom#44, d_same_day_ly#45, d_same_day_lq#46, d_current_day#47, ... 4 more fields], 0
         |:- ModularTable default, store, [s_store_sk#53, s_store_id#54, s_rec_start_date#55, s_rec_end_date#56, s_closed_date_sk#57, s_store_name#58, s_number_employees#59, s_floor_space#60, s_hours#61, s_manager#62, s_market_id#63, s_geography_class#64, s_market_desc#65, s_market_manager#66, s_division_id#67, s_division_name#68, s_company_id#69, s_company_name#70, s_street_number#71, s_street_name#72, s_street_type#73, s_suite_number#74, s_city#75, s_county#76, ... 5 more fields], 0
         |+- ModularTable default, customer, [c_customer_sk#82, c_customer_id#83, c_current_cdemo_sk#84, c_current_hdemo_sk#85, c_current_addr_sk#86, c_first_shipto_date_sk#87, c_first_sales_date_sk#88, c_salutation#89, c_first_name#90, c_last_name#91, c_preferred_cust_flag#92, c_birth_day#93, c_birth_month#94, c_birth_year#95, c_birth_country#96, c_login#97, c_email_address#98, c_last_review_date#99], 0
       """.stripMargin.trim,
      s"""
         |!Select [d_week_seq1#105, round(CheckOverflow((sun_sales1#106 / sun_sales2#114), DecimalType(37,20)), 2) AS round((sun_sales1 / sun_sales2), 2)#291, round(CheckOverflow((mon_sales1#107 / mon_sales2#115), DecimalType(37,20)), 2) AS round((mon_sales1 / mon_sales2), 2)#292, round(CheckOverflow((tue_sales1#108 / tue_sales2#116), DecimalType(37,20)), 2) AS round((tue_sales1 / tue_sales2), 2)#293, round(CheckOverflow((wed_sales1#109 / wed_sales2#117), DecimalType(37,20)), 2) AS round((wed_sales1 / wed_sales2), 2)#294, round(CheckOverflow((thu_sales1#110 / thu_sales2#118), DecimalType(37,20)), 2) AS round((thu_sales1 / thu_sales2), 2)#295, round(CheckOverflow((fri_sales1#111 / fri_sales2#119), DecimalType(37,20)), 2) AS round((fri_sales1 / fri_sales2), 2)#296, round(CheckOverflow((sat_sales1#112 / sat_sales2#120), DecimalType(37,20)), 2) AS round((sat_sales1 / sat_sales2), 2)#297], [d_week_seq#204, sun_sales#125, mon_sales#126, tue_sales#127, wed_sales#128, thu_sales#129, fri_sales#130, sat_sales#131, d_date_sk#235, d_date_id#236, d_date#237, d_month_seq#238, d_week_seq#239, d_quarter_seq#240, d_year#241, d_dow#242, d_moy#243, d_dom#244, d_qoy#245, d_fy_year#246, d_fy_quarter_seq#247, d_fy_week_seq#248, d_day_name#249, d_quarter_name#250, ... 48 more fields], [(d_year#241 = 2001), (d_week_seq#239 = d_week_seq#204), (d_year#269 = 2002), (d_week_seq#267 = d_week_seq#204), (d_week_seq1#105 = (d_week_seq2#113 - 53))], Map(1 -> date_dim, 3 -> date_dim), [JoinEdge(0,1,Inner), JoinEdge(2,3,Inner)], 12, [List(ArrayBuffer(d_week_seq1#105 ASC NULLS FIRST))]   "!Select [d_week_seq1#105, round(CheckOverflow((sun_sales1#106 / sun_sales2#114), DecimalType(37,20)), 2) AS round((sun_sales1 / sun_sales2), 2)#291, round(CheckOverflow((mon_sales1#107 / mon_sales2#115), DecimalType(37,20)), 2) AS round((mon_sales1 / mon_sales2), 2)#292, round(CheckOverflow((tue_sales1#108 / tue_sales2#116), DecimalType(37,20)), 2) AS round((tue_sales1 / tue_sales2), 2)#293, round(CheckOverflow((wed_sales1#109 / wed_sales2#117), DecimalType(37,20)), 2) AS round((wed_sales1 / wed_sales2), 2)#294, round(CheckOverflow((thu_sales1#110 / thu_sales2#118), DecimalType(37,20)), 2) AS round((thu_sales1 / thu_sales2), 2)#295, round(CheckOverflow((fri_sales1#111 / fri_sales2#119), DecimalType(37,20)), 2) AS round((fri_sales1 / fri_sales2), 2)#296, round(CheckOverflow((sat_sales1#112 / sat_sales2#120), DecimalType(37,20)), 2) AS round((sat_sales1 / sat_sales2), 2)#297], [d_week_seq#204, sun_sales#125, mon_sales#126, tue_sales#127, wed_sales#128, thu_sales#129, fri_sales#130, sat_sales#131, d_date_sk#235, d_date_id#236, d_date#237, d_month_seq#238, d_week_seq#239, d_quarter_seq#240, d_year#241, d_dow#242, d_moy#243, d_dom#244, d_qoy#245, d_fy_year#246, d_fy_quarter_seq#247, d_fy_week_seq#248, d_day_name#249, d_quarter_name#250, ... 48 more fields], [(d_year#241 = 2001), (d_week_seq#239 = d_week_seq#204), (d_year#269 = 2002), (d_week_seq#267 = d_week_seq#204), (d_week_seq1#105 = (d_week_seq2#113 - 53))], Map(1 -> date_dim, 3 -> date_dim), [JoinEdge(0,1,Inner), JoinEdge(2,3,Inner)], 12, [List(ArrayBuffer(d_week_seq1#105 ASC NULLS FIRST))]
         |:- GroupBy [d_week_seq#204, sum(CASE WHEN (d_day_name#214 = Sunday) THEN sales_price#122 ELSE null END) AS sun_sales#125, sum(CASE WHEN (d_day_name#214 = Monday) THEN sales_price#122 ELSE null END) AS mon_sales#126, sum(CASE WHEN (d_day_name#214 = Tuesday) THEN sales_price#122 ELSE null END) AS tue_sales#127, sum(CASE WHEN (d_day_name#214 = Wednesday) THEN sales_price#122 ELSE null END) AS wed_sales#128, sum(CASE WHEN (d_day_name#214 = Thursday) THEN sales_price#122 ELSE null END) AS thu_sales#129, sum(CASE WHEN (d_day_name#214 = Friday) THEN sales_price#122 ELSE null END) AS fri_sales#130, sum(CASE WHEN (d_day_name#214 = Saturday) THEN sales_price#122 ELSE null END) AS sat_sales#131], [sales_price#122, d_week_seq#204, d_day_name#214], [d_week_seq#204], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ":- GroupBy [d_week_seq#204, sum(CASE WHEN (d_day_name#214 = Sunday) THEN sales_price#122 ELSE null END) AS sun_sales#125, sum(CASE WHEN (d_day_name#214 = Monday) THEN sales_price#122 ELSE null END) AS mon_sales#126, sum(CASE WHEN (d_day_name#214 = Tuesday) THEN sales_price#122 ELSE null END) AS tue_sales#127, sum(CASE WHEN (d_day_name#214 = Wednesday) THEN sales_price#122 ELSE null END) AS wed_sales#128, sum(CASE WHEN (d_day_name#214 = Thursday) THEN sales_price#122 ELSE null END) AS thu_sales#129, sum(CASE WHEN (d_day_name#214 = Friday) THEN sales_price#122 ELSE null END) AS fri_sales#130, sum(CASE WHEN (d_day_name#214 = Saturday) THEN sales_price#122 ELSE null END) AS sat_sales#131], [sales_price#122, d_week_seq#204, d_day_name#214], [d_week_seq#204], 0
         |:  +- Select [sales_price#122, d_week_seq#204, d_day_name#214], [sold_date_sk#121, sales_price#122, d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, ... 6 more fields], [(d_date_sk#200 = sold_date_sk#121)], Map(1 -> date_dim), [JoinEdge(0,1,Inner)], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ":  +- Select [sales_price#122, d_week_seq#204, d_day_name#214], [sold_date_sk#121, sales_price#122, d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, ... 6 more fields], [(d_date_sk#200 = sold_date_sk#121)], Map(1 -> date_dim), [JoinEdge(0,1,Inner)], 0
         |:     :- Union 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ":     :- Union 0
         |:     :  :- Select [ws_sold_date_sk#132 AS sold_date_sk#121, ws_ext_sales_price#155 AS sales_price#122], [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], Map(0 -> web_sales), 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ":     :  :- Select [ws_sold_date_sk#132 AS sold_date_sk#121, ws_ext_sales_price#155 AS sales_price#122], [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], Map(0 -> web_sales), 0
         |:     :  :  +- ModularTable default, web_sales, [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ":     :  :  +- ModularTable default, web_sales, [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], 0
         |:     :  +- Select [cs_sold_date_sk#166 AS sold_date_sk#123, cs_ext_sales_price#189 AS sales_price#124], [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], Map(0 -> catalog_sales), 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ":     :  +- Select [cs_sold_date_sk#166 AS sold_date_sk#123, cs_ext_sales_price#189 AS sales_price#124], [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], Map(0 -> catalog_sales), 0
         |:     :     +- ModularTable default, catalog_sales, [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ":     :     +- ModularTable default, catalog_sales, [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], 0
         |:     +- ModularTable default, date_dim, [d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, d_same_day_lq#222, d_current_day#223, ... 4 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ":     +- ModularTable default, date_dim, [d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, d_same_day_lq#222, d_current_day#223, ... 4 more fields], 0
         |:- ModularTable default, date_dim, [d_date_sk#235, d_date_id#236, d_date#237, d_month_seq#238, d_week_seq#239, d_quarter_seq#240, d_year#241, d_dow#242, d_moy#243, d_dom#244, d_qoy#245, d_fy_year#246, d_fy_quarter_seq#247, d_fy_week_seq#248, d_day_name#249, d_quarter_name#250, d_holiday#251, d_weekend#252, d_following_holiday#253, d_first_dom#254, d_last_dom#255, d_same_day_ly#256, d_same_day_lq#257, d_current_day#258, ... 4 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ":- ModularTable default, date_dim, [d_date_sk#235, d_date_id#236, d_date#237, d_month_seq#238, d_week_seq#239, d_quarter_seq#240, d_year#241, d_dow#242, d_moy#243, d_dom#244, d_qoy#245, d_fy_year#246, d_fy_quarter_seq#247, d_fy_week_seq#248, d_day_name#249, d_quarter_name#250, d_holiday#251, d_weekend#252, d_following_holiday#253, d_first_dom#254, d_last_dom#255, d_same_day_ly#256, d_same_day_lq#257, d_current_day#258, ... 4 more fields], 0
         |:- GroupBy [d_week_seq#204, sum(CASE WHEN (d_day_name#214 = Sunday) THEN sales_price#122 ELSE null END) AS sun_sales#125, sum(CASE WHEN (d_day_name#214 = Monday) THEN sales_price#122 ELSE null END) AS mon_sales#126, sum(CASE WHEN (d_day_name#214 = Tuesday) THEN sales_price#122 ELSE null END) AS tue_sales#127, sum(CASE WHEN (d_day_name#214 = Wednesday) THEN sales_price#122 ELSE null END) AS wed_sales#128, sum(CASE WHEN (d_day_name#214 = Thursday) THEN sales_price#122 ELSE null END) AS thu_sales#129, sum(CASE WHEN (d_day_name#214 = Friday) THEN sales_price#122 ELSE null END) AS fri_sales#130, sum(CASE WHEN (d_day_name#214 = Saturday) THEN sales_price#122 ELSE null END) AS sat_sales#131], [sales_price#122, d_week_seq#204, d_day_name#214], [d_week_seq#204], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ":- GroupBy [d_week_seq#204, sum(CASE WHEN (d_day_name#214 = Sunday) THEN sales_price#122 ELSE null END) AS sun_sales#125, sum(CASE WHEN (d_day_name#214 = Monday) THEN sales_price#122 ELSE null END) AS mon_sales#126, sum(CASE WHEN (d_day_name#214 = Tuesday) THEN sales_price#122 ELSE null END) AS tue_sales#127, sum(CASE WHEN (d_day_name#214 = Wednesday) THEN sales_price#122 ELSE null END) AS wed_sales#128, sum(CASE WHEN (d_day_name#214 = Thursday) THEN sales_price#122 ELSE null END) AS thu_sales#129, sum(CASE WHEN (d_day_name#214 = Friday) THEN sales_price#122 ELSE null END) AS fri_sales#130, sum(CASE WHEN (d_day_name#214 = Saturday) THEN sales_price#122 ELSE null END) AS sat_sales#131], [sales_price#122, d_week_seq#204, d_day_name#214], [d_week_seq#204], 0
         |:  +- Select [sales_price#122, d_week_seq#204, d_day_name#214], [sold_date_sk#121, sales_price#122, d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, ... 6 more fields], [(d_date_sk#200 = sold_date_sk#121)], Map(1 -> date_dim), [JoinEdge(0,1,Inner)], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ":  +- Select [sales_price#122, d_week_seq#204, d_day_name#214], [sold_date_sk#121, sales_price#122, d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, ... 6 more fields], [(d_date_sk#200 = sold_date_sk#121)], Map(1 -> date_dim), [JoinEdge(0,1,Inner)], 0
         |:     :- Union 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ":     :- Union 0
         |:     :  :- Select [ws_sold_date_sk#132 AS sold_date_sk#121, ws_ext_sales_price#155 AS sales_price#122], [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], Map(0 -> web_sales), 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ":     :  :- Select [ws_sold_date_sk#132 AS sold_date_sk#121, ws_ext_sales_price#155 AS sales_price#122], [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], Map(0 -> web_sales), 0
         |:     :  :  +- ModularTable default, web_sales, [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ":     :  :  +- ModularTable default, web_sales, [ws_sold_date_sk#132, ws_sold_time_sk#133, ws_ship_date_sk#134, ws_item_sk#135, ws_bill_customer_sk#136, ws_bill_cdemo_sk#137, ws_bill_hdemo_sk#138, ws_bill_addr_sk#139, ws_ship_customer_sk#140, ws_ship_cdemo_sk#141, ws_ship_hdemo_sk#142, ws_ship_addr_sk#143, ws_web_page_sk#144, ws_web_site_sk#145, ws_ship_mode_sk#146, ws_warehouse_sk#147, ws_promo_sk#148, ws_order_number#149L, ws_quantity#150, ws_wholesale_cost#151, ws_list_price#152, ws_sales_price#153, ws_ext_discount_amt#154, ws_ext_sales_price#155, ... 10 more fields], 0
         |:     :  +- Select [cs_sold_date_sk#166 AS sold_date_sk#123, cs_ext_sales_price#189 AS sales_price#124], [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], Map(0 -> catalog_sales), 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ":     :  +- Select [cs_sold_date_sk#166 AS sold_date_sk#123, cs_ext_sales_price#189 AS sales_price#124], [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], Map(0 -> catalog_sales), 0
         |:     :     +- ModularTable default, catalog_sales, [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wholesale_cost#185, cs_list_price#186, cs_sales_price#187, cs_ext_discount_amt#188, cs_ext_sales_price#189, ... 10 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ":     :     +- ModularTable default, catalog_sales, [cs_sold_date_sk#166, cs_sold_time_sk#167, cs_ship_date_sk#168, cs_bill_customer_sk#169, cs_bill_cdemo_sk#170, cs_bill_hdemo_sk#171, cs_bill_addr_sk#172, cs_ship_customer_sk#173, cs_ship_cdemo_sk#174, cs_ship_hdemo_sk#175, cs_ship_addr_sk#176, cs_call_center_sk#177, cs_catalog_page_sk#178, cs_ship_mode_sk#179, cs_warehouse_sk#180, cs_item_sk#181, cs_promo_sk#182, cs_order_number#183L, cs_quantity#184, cs_wh...
         |:     +- ModularTable default, date_dim, [d_date_sk#200, d_date_id#201, d_date#202, d_month_seq#203, d_week_seq#204, d_quarter_seq#205, d_year#206, d_dow#207, d_moy#208, d_dom#209, d_qoy#210, d_fy_year#211, d_fy_quarter_seq#212, d_fy_week_seq#213, d_day_name#214, d_quarter_name#215, d_holiday#216, d_weekend#217, d_following_holiday#218, d_first_dom#219, d_last_dom#220, d_same_day_ly#221, d_same_day_lq#222, d_current_day#223, ... 4 more fields], 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
         |+- ModularTable default, date_dim, [d_date_sk#263, d_date_id#264, d_date#265, d_month_seq#266, d_week_seq#267, d_quarter_seq#268, d_year#269, d_dow#270, d_moy#271, d_dom#272, d_qoy#273, d_fy_year#274, d_fy_quarter_seq#275, d_fy_week_seq#276, d_day_name#277, d_quarter_name#278, d_holiday#279, d_weekend#280, d_following_holiday#281, d_first_dom#282, d_last_dom#283, d_same_day_ly#284, d_same_day_lq#285, d_current_day#286, ... 4 more fields], 0
       """.stripMargin.trim
      )
  
  test("typical mqo test") {
    
    tpcds1_4Tables.foreach { create_table =>
      hiveClient.runSqlHive(create_table)
    }

    val pBatch = mutable.ArrayBuffer[ModularPlan]()

    val qIterator = Tpcds_1_4_QueryBatch.tpcds1_4Queries.slice(0,2).map(_._2).iterator
    
    val qLogEntryPattern = """(?s)^(.*?)$"""
    
    val mvtool = new MVToolTest
    
    mvtool.batchQueries(testHive.sparkSession,qIterator,qLogEntryPattern.r,pBatch)
    
    val batch = pBatch.map(_.toString.stripMargin.trim)

    comparePlanCollections(batch, correctPlanBatch)
  }
  
}